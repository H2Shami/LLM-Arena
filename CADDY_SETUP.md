# Caddy Reverse Proxy Setup

Caddy handles routing for the preview system:
- Main app: `main.localhost`
- Previews: `{run_id}.preview.localhost`

## Why Caddy?

- âœ… **Automatic HTTPS** (Let's Encrypt)
- âœ… **Dynamic reverse proxy** (can call APIs to resolve backends)
- âœ… **Simple configuration**
- âœ… **Built-in rate limiting**
- âœ… **Zero-downtime reloads**

## Installation

### macOS (Homebrew)
```bash
brew install caddy
```

### Linux (apt)
```bash
sudo apt install -y debian-keyring debian-archive-keyring apt-transport-https curl
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy
```

### Docker
```bash
docker run -d \\
  --name caddy \\
  -p 80:80 \\
  -p 443:443 \\
  -v $PWD/Caddyfile:/etc/caddy/Caddyfile \\
  -v caddy_data:/data \\
  -v caddy_config:/config \\
  caddy:latest
```

## Local Development

For local development, use `.localhost` domains (they resolve to 127.0.0.1 automatically):

1. **Start main app**
   ```bash
   npm run dev
   ```

2. **Start orchestrator**
   ```bash
   cd orchestrator && npm run dev
   ```

3. **Start Caddy**
   ```bash
   caddy run
   ```

4. **Access the site**
   - Main app: http://main.localhost
   - Previews will be at: http://{run_id}.preview.localhost

### Testing Caddy Configuration

```bash
# Validate Caddyfile syntax
caddy validate

# Test configuration
caddy adapt --config Caddyfile

# Start with verbose logging
caddy run --watch
```

## Production Setup

### 1. DNS Configuration

Point your domain to your server:

```dns
main.example.com         A      your.server.ip
*.preview.example.com    A      your.server.ip
```

### 2. Update Caddyfile

Replace `.localhost` with your domain:

```caddyfile
# Change this:
main.localhost {
    ...
}

*.preview.localhost {
    ...
}

# To this:
main.example.com {
    ...
}

*.preview.example.com {
    ...
}
```

### 3. Update Environment Variables

```bash
# .env
NEXT_PUBLIC_PREVIEW_DOMAIN="preview.example.com"
```

### 4. Start Caddy as a System Service

```bash
# Install as system service (Linux)
sudo caddy start

# Or use systemd
sudo systemctl enable caddy
sudo systemctl start caddy
sudo systemctl status caddy
```

## How It Works

### Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Client Browser                                          â”‚
â”‚  https://run_abc123.preview.example.com                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Caddy (Port 443)                                        â”‚
â”‚  1. Extract run_id from subdomain                       â”‚
â”‚  2. Call: GET http://localhost:8080/gateway/resolve/...â”‚
â”‚  3. Orchestrator returns: {"url": "http://localhost:3042"}â”‚
â”‚  4. Proxy request to localhost:3042                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Docker Container (Port 3042)                           â”‚
â”‚  Next.js production server                              â”‚
â”‚  Generated by LLM                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Dynamic Upstream Resolution

Caddy's `dynamic http` feature allows it to:

1. Call an API endpoint (orchestrator) at request time
2. Parse the JSON response
3. Use the `url` field as the proxy target

This means:
- âœ… No static upstream configuration
- âœ… Containers can be created/destroyed dynamically
- âœ… Caddy automatically routes to the right port
- âœ… No manual configuration updates needed

## Security

### Headers

Caddy adds these security headers:

```
X-Frame-Options: SAMEORIGIN
X-Content-Type-Options: nosniff
Content-Security-Policy: default-src 'self'; ...
Referrer-Policy: no-referrer
```

### Rate Limiting

Limits per preview:
- **100 requests per minute** per run_id

### Timeouts

- Read timeout: 10s (default), 30s (API routes)
- Write timeout: 10s (default), 30s (API routes)

## Monitoring

### Logs

```bash
# Main app logs
tail -f /var/log/caddy/main.log

# Preview logs
tail -f /var/log/caddy/preview.log
```

### Metrics

Caddy exposes metrics on port 2019:

```bash
curl http://localhost:2019/metrics
```

### Health Check

```bash
curl http://localhost:2019/health
# Response: OK
```

## Troubleshooting

### Caddy won't start

```bash
# Check if ports are in use
lsof -i :80
lsof -i :443

# Check Caddyfile syntax
caddy validate
```

### Preview shows "not available"

```bash
# Check orchestrator is running
curl http://localhost:8080/health

# Check run exists
curl http://localhost:8080/gateway/resolve/{run_id}
```

### SSL certificate issues (production)

```bash
# Check Let's Encrypt rate limits
caddy list-certificates

# Force certificate renewal
caddy reload
```

## Advanced Configuration

### Custom SSL Certificates

```caddyfile
main.example.com {
    tls /path/to/cert.pem /path/to/key.pem
    ...
}
```

### Logging to External Service

```caddyfile
*.preview.example.com {
    log {
        output net tcp://logstash:5000
        format json
    }
}
```

### Load Balancing (Multiple Orchestrators)

```caddyfile
*.preview.example.com {
    reverse_proxy {
        dynamic http {
            # Round-robin across multiple orchestrators
            uri http://orchestrator1:8080/gateway/resolve/{re.subdomain.run_id}
            uri http://orchestrator2:8080/gateway/resolve/{re.subdomain.run_id}
        }
    }
}
```

## Next Steps

Once Caddy is running:

1. âœ… Visit http://main.localhost
2. âœ… Create a session
3. âœ… Watch models compete
4. âœ… View live previews at `{run_id}.preview.localhost`

ğŸ‰ Your complete system is now operational!
